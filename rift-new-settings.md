# Rift Enhancements - New project.conf settings


## Introduction

This document explains all the new project.conf settings for use with the [ParaTools enhancements to Rift](https://github.com/cea-hpc/rift/pull/29).

These settings were merged to cea-hpc/rift as part of:
* [ ParaTools Enhancements to Rift for S3-Based Annex, and more #29 ](https://github.com/cea-hpc/rift/pull/29)


## Contents

1. [Comprehensive List of New Settings](#1-comprehensive-list-of-new-settings)
- [idp_app_token](#idp_app_token)
- [idp_auth_endpoint](#idp_auth_endpoint)
- [s3_credential_file](#s3_credential_file)
- [s3_auth_endpoint](#s3_auth_endpoint)
- [annex_is_s3](#annex_is_s3)
- [staging_annex](#staging_annex)

<br />


## 1. Comprehensive List of New Settings

The following settings are new to project.conf:

* `idp_app_token` (generally optional, but required if using `rift auth`)
* `idp_auth_endpoint` (generally optional, but required if using `rift auth`)
* `s3_credential_file` (optional)
* `s3_auth_endpoint` (generally optional, but required if using `rift auth`)
* `annex_is_s3` (optional, defaults to False)
* `staging_annex` (optional, but required in order to read or write to an S3-based staging annex)

Each of these settings is explained in more detail in the sections below:

<br />

### idp_app_token

_This setting is required to use `rift auth`_, but otherwise it is optional.

If you will be using `rift auth` to access a non-public S3 annex, then `id_app_token` should be set to the application token generated by the Ocean administrators. This token is used as part of the authentication request to the IDP authentication endpoint, which is specified by `idp_auth_endpoint`.

<br />

### idp_auth_endpoint

_This setting is required to use `rift auth`_, but otherwise it is optional.

This should be set to the identity provider's authentication endpoint. This is the first endpoint used by `rift auth` in obtaining credentials for obtaining access to a non-public S3 annex, as specified by the `staging_annex` setting. Ocean administrators are responsible for providing this value. 

<br />

### s3_credential_file

This setting is an optional string which specifies the location of the JSON file where credentials fetched via `rift auth` are stored. The default value is `~/.rift/auth.json`. 

<br />

### s3_auth_endpoint

_This setting is required to use `rift auth`_, but otherwise it is optional.

This is the S3 authentication endpoint. It is the second endpoint that is used to fetch the credentials required to access a non-public S3 annex. Ocean administrators are responsible for providing this value.

<br />

### annex_is_s3

This is a boolean setting and is used to indicate whether `annex` is an S3 endpoint, or not. It defaults to `False`.

For instance, consider the following project.conf annex settings:
```
$> cat project.conf
...
annex: https://annexe-forge.ccc.ocre.cea.fr/oceantest/paratools-annex
annex_is_s3: True
...
# staging_annex is not specified
```

Here, because `annex_is_s3` is `True`, the URL will be treated as an S3 service with the following URL components:
1. S3 Endpoint = `https://annexe-forge.ccc.ocre.cea.fr`
2. S3 Bucket = `oceantest`
3. S3 Prefix = `paratools-annex`

And, because it is an S3 annex, if anonymous read access is enabled then `rift annex list` can be used to list the contents of the annex. This is in contrast to non-S3 http/s annex where listing of annex contents is not yet supported.

Additionally, `rift annex push` can be used to push to an S3-based `annex`, although the standard `rift auth` sequence must be completed in this case.

Please see the discussion that took place when this feature was designed for additional context and motivation:
* https://github.com/eugeneswalker/rift/pull/1#issuecomment-2984573374
* https://github.com/eugeneswalker/rift/pull/1#issuecomment-3018313131

<br />

### staging_annex

This setting is a string which specifies the http/s url for the S3 staging annex. There is no default value. This must be defined in order to use an S3 staging annex.

An example value for this is:
```
$> cat project.conf
...
staging_annex: https://annexe-forge.ccc.ocre.cea.fr/oceantest/paratools-annex
...
```

This value is parsed into the following S3 specification:
* S3 endpoint = `https://annexe-forge.ccc.ocre.cea.fr`
* S3 bucket = `oceantest`
* S3 prefix = `paratools-annex`

<br />

<br />

