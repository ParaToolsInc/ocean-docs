# Ocean Manager Documentation


## Introduction

This document provides instructions for using ocean-manager scripts migrated to GitLab.


## Contents

1. [Where to Find Ocean Manager Scripts](#1-where-to-find-ocean-manager-scripts)
2. [Repository Commit Used in this Documentation](#2-repository-commit-used-in-this-documentation)
3. [Nightly Build Workflow](#3-nightly-build-workflow)
4. [Nightly Test Workflow](#4-nightly-test-workflow)
5. [VM Image Build](#5-vm-image-build)
6. Sanity Check (in progress, not-done-yet)

<br />


## 1. Where to Find Ocean Manager Scripts

The Ocean Manager nightly-build and nightly-test scripts have been migrated to the `paratools/ocean-prod` GitLab Project.
* https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod

Additionally, the `sanity-check` and `create_img` Ocean tools scripts are being migrated now and will be added to the `paratools/ocean-prod` project.
Documentation for these additional scripts will be added here when they are complete.

<br />

## 2. Repository Commit Used in this Documentation

This documentation is written for the commit `c5983bd0aeb3226a68964954e581149c2b0f9402` from paratools/ocean-prod:
```
commit c5983bd0aeb3226a68964954e581149c2b0f9402 (HEAD -> main, origin/main)
Author: peyralansl <lpeyralans@paratools.com>
Date:   Sun Nov 2 20:27:18 2025 +0100

    add ci job to build rift vm image
```

Please keep this in mind when following instructions here.

<br />

## 3. Nightly Build Workflow

### Background Information

The Nightly Build workflow is generated from a combination of GitLab CI jobs statically and dynamically generated.

The static CI jobs are defined in `.gitlab-ci.yml`:
* [Nightly-Build-Generate](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/c5983bd0aeb3226a68964954e581149c2b0f9402/.gitlab-ci.yml#L19-31) - Lines 19-31
* [Nightly-Build](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/c5983bd0aeb3226a68964954e581149c2b0f9402/.gitlab-ci.yml#L33-42) - Lines 33-42

The purpose of these statically defined CI jobs is to allow a dynamic nightly-build pipeline to be generated. By generating the nightly-build pipeline dynamically, we can structure it such that build jobs are run with a degree of user-defined concurrency/parallelism. This is done using a GitLab feature called Parent-Child Downstream Pipelines. Please see the official documentation for general information on this GitLab feature:
* https://docs.gitlab.com/ci/pipelines/downstream_pipelines/

The dynamic CI jobs are generated by, and executed using, the scripts in the [nightly-build directory](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/c5983bd0aeb3226a68964954e581149c2b0f9402/nightly-build).

### Running the Workflow

This workflow can be triggered either manually, or by scheduling the workflow to run on some user-defined interval.

#### Manual Trigger

To manually trigger the workflow, navigate to the left-hand menu and select "Build" and then select "Pipelines." See screenshot below:
<br />

<img width="1353" height="702" alt="Screenshot 2025-10-22 at 12 05 17 PM" src="https://github.com/user-attachments/assets/4fa9c75b-b8f0-4dd3-bef1-daa892a482ea" />

<br />

<br />

Then, click on the blue button in the upper right "New Pipeline"
<br />

<img width="1353" height="223" alt="Screenshot 2025-10-22 at 12 07 36 PM" src="https://github.com/user-attachments/assets/ca329ade-04ac-4627-ace0-bceab76820ff" />

<br />

<br />

There are three variables you are required to define in order to invoke the Nightly Build workflow:
1. `OCEAN_BRANCH` - this identifies the branch from the Ocean project that will be used
2. `CONCURRENCY`* - this should be a number specifying the number of build jobs which are allowed to run in parallel / concurrently
3. `JOBS` - this variable should include the string "nightly-build"

See the screenshot below for what this should look like:
<br />

<img width="1353" height="685" alt="Screenshot 2025-10-22 at 12 09 56 PM" src="https://github.com/user-attachments/assets/df539b82-6a55-44a9-89b4-546cefdef743" />

<br />

<br />

_* A note about the value of `CONCURRENCY`: this integer should not be larger than the max concurrency supported by your gitlab-runner configuration. For instance, if you were to set a value of CONCURRENCY=10 but you had configured your gitlab-runner to only support 5 concurrent jobs, only 5 build jobs would run concurrently._

Once you have defined the required variables, scroll down and click the blue button labeled "New Pipeline"
<br />

<img width="1353" height="469" alt="Screenshot 2025-10-22 at 12 20 06 PM" src="https://github.com/user-attachments/assets/49e6b0a2-f6c0-4dae-9a27-b5ba8ec9f395" />

<br />

<br />

You should initially see only the Nightly-Build-Generate job running. The purpose of this job is to split up all the package builds into a number of buckets corresponding to the value of `CONCURRENCY`. 
<br />

<img width="1353" height="469" alt="Screenshot 2025-10-22 at 12 21 08 PM" src="https://github.com/user-attachments/assets/2465b922-adb9-464b-95e4-786473cff951" />

<br />

It should only take a short period of time before the Nightly-Build-Generate job completes, at which point the Nightly-Build Downstream job will be triggered. Once this happens, you should be able to expand that job and see the full set of build jobs that are being run. It will look something like this:
<br />

<img width="1353" height="744" alt="Screenshot 2025-10-22 at 12 23 00 PM" src="https://github.com/user-attachments/assets/47743fc1-d1ba-45d6-a97a-727afc84a9cb" />

<br />

#### Scheduled Pipeline

The Nightly Build workflow can be scheduled to run on an interval by going to Build -> Pipeline Schedules on the left menu.
<br />

<img width="1353" height="744" alt="Screenshot 2025-10-22 at 12 26 55 PM" src="https://github.com/user-attachments/assets/c13d5819-2e99-48d1-aada-5e22480d801c" />

<br />

Once here, select the blue button in the upper right labeled "New Schedule"

<br />

<img width="1353" height="172" alt="Screenshot 2025-10-22 at 12 28 08 PM" src="https://github.com/user-attachments/assets/3ae0fb05-df6c-44d2-a060-ab23041ff6be" />

<br />

Fill out the fields on the New Schedule page and *be sure to define the three required variables described in the Manual Trigger section* - namely: `OCEAN_BRANCH`, `CONCURRENCY`, and make sure the value of `JOBS` includes the string "nightly-build"


## 4. Nightly Test Workflow

### Background Information

The Nightly Test workflow is generated from a combination of GitLab CI jobs statically and dynamically generated.

The static CI jobs are defined in `.gitlab-ci.yml`:
* [Nightly-Test-Generate](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/c5983bd0aeb3226a68964954e581149c2b0f9402/.gitlab-ci.yml#L44-56) - Lines 44-56
* [Nightly-Test](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/c5983bd0aeb3226a68964954e581149c2b0f9402/.gitlab-ci.yml#L58-67) - Lines 58-67

The purpose of these statically defined CI jobs is to allow a dynamic nightly-test pipeline to be generated. By generating the pipeline dynamically, we can structure it such that jobs are run with a degree of user-defined concurrency/parallelism. This is done using a GitLab feature called Parent-Child Downstream Pipelines. Please see the official documentation for general information on this GitLab feature:
* https://docs.gitlab.com/ci/pipelines/downstream_pipelines/

The dynamic CI jobs are generated by, and executed using, the scripts in the [nightly-test directory](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/c5983bd0aeb3226a68964954e581149c2b0f9402/nightly-test).

### Running the Workflow

This workflow can be triggered either manually, or by scheduling the workflow to run on some user-defined interval.

#### Manual Trigger

To manually trigger the workflow, follow the same steps from the Nightly Build Workflow manual trigger section above. The same variables required to run that workflow are also required for Nightly Test Workflow, except that the value of `JOBS` must include "nightly-test" instead of "nightly-build."

These are the three required variables:
1. `OCEAN_BRANCH` - this identifies the branch from the Ocean project that will be used
2. `CONCURRENCY`* - this should be a number specifying the number of build jobs which are allowed to run in parallel / concurrently
3. `JOBS` - this variable should include the string "nightly-test"

<br />

<img width="1353" height="793" alt="Screenshot 2025-10-22 at 12 40 22 PM" src="https://github.com/user-attachments/assets/2626bda3-29a2-42b5-bbca-3d8a41cbe010" />

<br />

Once the pipeline is triggered, it will look like this at first:

<br />

<img width="1353" height="503" alt="Screenshot 2025-10-22 at 12 41 54 PM" src="https://github.com/user-attachments/assets/669574e3-c662-422c-a286-6e22255ab8c2" />

<br />

You should initially see only the Nightly-Test-Generate job running. The purpose of this job is to split up all the package tests into a number of buckets corresponding to the value of `CONCURRENCY`. 

<br />

It should only take a short period of time before the Nightly-Test-Generate job completes, at which point the Nightly-Test Downstream job will be triggered. Once this happens, you should be able to expand that job and see the full set of build jobs that are being run. It will look something like this:
<br />

<img width="1353" height="777" alt="Screenshot 2025-10-22 at 12 44 29 PM" src="https://github.com/user-attachments/assets/251edeb6-3d00-46a2-8789-2a81fefc70c5" />

<br />

#### Scheduled Pipeline

Please follow the instructions in the Nightly Buid workflow section on how to schedule a pipeline run. The same steps apply to the Nightly Test Workflow. The only difference is that you must set the value of `JOBS` CI variable to include "nightly-test" instead of "nightly-build"

Fill out the fields on the New Schedule page and *be sure to define the three required variables described in the Manual Trigger section* - namely: `OCEAN_BRANCH`, `CONCURRENCY`, and make sure the value of `JOBS` includes the string "nightly-build"

<br />

## 5. VM Image Build

### Background Information

The VM Build CI jobs are defined in the following files:

In `.gitlab-ci.yml` as the following CI jobs:
* [VM-Build-x86_64](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/c5983bd0aeb3226a68964954e581149c2b0f9402/.gitlab-ci.yml#L69-81) - Lines 69-81
* [VM-Build-aarch64](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/c5983bd0aeb3226a68964954e581149c2b0f9402/.gitlab-ci.yml#L83-95) - Lines 83-95

And there are associated scripts in the [create-vm-image](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/c5983bd0aeb3226a68964954e581149c2b0f9402/create-vm-image) path.

### Running the workflow

The Rift VM images can be built with GitLab CI by following the instructions below. These VM images are constructed according to the logic embedded in `rift vm build`.

There are two required parameters that need to be specified to control the building of Rift VM's using GitLab CI:
1. The Ocean branch used (eg. 4.4)
2. The target hardware architecture (x86_64 or aarch64)

These required parameters are specified as GitLab CI Pipeline variables when launching the pipeline either manually or on a schedule.
1. The variable `OCEAN_BRANCH` should be set to the Ocean branch that will be used
2. The variable `JOBS` should be set to either `vm-build-x86_64` or `vm-build-aarch64`. Alternatively, `JOBS` can be set so that both of these strings are present and separated by a space, and this will trigger VM to be built for both architectures.

To manually trigger the VM build workflow, navigate to the left-hand menu and select "Build" and then select "Pipelines." Once in the pipeline view, click on the blue button labeled "New Pipeline" in the upper right. On the next screen, specify the required pipeline variables and then select the blue button in the lower left that says "New Pipeline"
<br />

<img width="1261" height="634" alt="Screenshot 2025-11-02 at 12 09 34 PM" src="https://github.com/user-attachments/assets/472dfd43-1afe-4ed8-95c7-96b1f37056bf" />

<br />

The newly created pipeline should show a job called "VM-Build-x86_64."
<br />

<img width="1320" height="470" alt="Screenshot 2025-11-02 at 1 12 33 PM" src="https://github.com/user-attachments/assets/f196dc67-2322-4aea-8383-ddfaaa749efc" />

<br />

This job will generate a new VM by running `rift vm build` on the specified Ocean branch and then copy it to the Harbor forge.

The final portion of the job output should confirm the VM has been created and show the transfer to Harbor.
<br />

<img width="1320" height="768" alt="Screenshot 2025-11-02 at 1 18 02 PM" src="https://github.com/user-attachments/assets/84a3a7c9-3229-4a8d-8570-239e328c0d2f" />

<br />

That the new VM image has been transferred to the Harbor can be further confirmed by manually SFTP'ing and checking:
<br />

<img width="1001" height="211" alt="Screenshot 2025-11-02 at 1 20 42 PM" src="https://github.com/user-attachments/assets/e211d50b-6b9c-4bfd-9765-7575522501da" />

<br />

<br />





