# Ocean Manager Documentation


## Introduction

This document provides instructions for using ocean-manager scripts migrated to GitLab.


## Contents

1. [Where to Find Ocean Manager Scripts](#1-where-to-find-ocean-manager-scripts)
2. [Repository Commit Used in this Documentation](#2-repository-commit-used-in-this-documentation)
3. [Nightly Build Workflow](#3-nightly-build-workflow)
4. [Nightly Test Workflow](#4-nightly-test-workflow)
5. [VM Image Build](#5-vm-image-build)
6. [Sanity Check](#6-sanity-check)

<br />


## 1. Where to Find Ocean Manager Scripts

The Ocean Manager nightly-build and nightly-test scripts have been migrated to the `paratools/ocean-prod` GitLab Project.
* https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod

Additionally, the `sanity-check` and `create_img` Ocean tools scripts are being migrated now and will be added to the `paratools/ocean-prod` project.
Documentation for these additional scripts will be added here when they are complete.

<br />

## 2. Repository Commit Used in this Documentation

This documentation is written for the commit `f6be3bc459b61c67b070a8fdaff0025315b33170` from paratools/ocean-prod:
```
commit f6be3bc459b61c67b070a8fdaff0025315b33170 (HEAD -> main, origin/main)
Author: peyralansl <lpeyralans@paratools.com>
Date:   Mon Nov 24 01:06:41 2025 +0100

    add sanity check job; rely on gitlab inputs to trigger ocean-tools jobs [ci skip]
```

Please keep this in mind when following instructions here.

<br />

## 3. Nightly Build Workflow

### Background Information

The Nightly Build workflow is generated from a combination of GitLab CI jobs statically and dynamically generated.

The static CI jobs are defined in `.gitlab-ci.yml`:
* [Nightly-Build-Generate](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L58-72) - Lines 58-72
* [Nightly-Build](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L74-82) - Lines 74-82

The purpose of these statically defined CI jobs is to allow a dynamic nightly-build pipeline to be generated. By generating the nightly-build pipeline dynamically, we can structure it such that build jobs are run with a degree of user-defined concurrency/parallelism. This is done using a GitLab feature called Parent-Child Downstream Pipelines. Please see the official documentation for general information on this GitLab feature:
* https://docs.gitlab.com/ci/pipelines/downstream_pipelines/

The dynamic CI jobs are generated by, and executed using, the scripts in the [nightly-build directory](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/f6be3bc459b61c67b070a8fdaff0025315b33170/nightly-build).

### Running the Workflow

This workflow can be triggered either manually, or by scheduling the workflow to run on some user-defined interval.

#### Manual Trigger

To manually trigger the workflow, go to Build -> Pipelines using the menu on the left. Then, click the blue button labeled "New Pipeline" in the upper right.

In the "Run new pipeline" screen, set the following pipeline Inputs:
* Set **ocean_branch** to the target branch
* Set **nightly_build** to True.
* Set **concurrency** to the desired degree of parallelism*

_* A note about the value of `CONCURRENCY`: this integer should not be larger than the max concurrency supported by your gitlab-runner configuration. For instance, if you were to set a value of CONCURRENCY=10 but you had configured your gitlab-runner to only support 5 concurrent jobs, only 5 build jobs would run concurrently._

<br />

<img width="1333" height="572" alt="Screenshot 2025-11-23 at 5 45 37 PM" src="https://github.com/user-attachments/assets/06b7db82-0347-416b-aaff-cc02ba71907b" />

<br />

Once you've done this, click the blue button at the bottom labeled "New Pipeline."

You should initially see only the Nightly-Build-Generate job running. The purpose of this job is to split up all the package builds into a number of buckets corresponding to the value of `concurrency`. 

<br />

<img width="1353" height="469" alt="Screenshot 2025-10-22 at 12 21 08 PM" src="https://github.com/user-attachments/assets/2465b922-adb9-464b-95e4-786473cff951" />

<br />

It should only take a short period of time before the Nightly-Build-Generate job completes, at which point the Nightly-Build Downstream job will be triggered. Once this happens, you should be able to expand that job and see the full set of build jobs that are being run. It will look something like this:
<br />

<img width="1353" height="744" alt="Screenshot 2025-10-22 at 12 23 00 PM" src="https://github.com/user-attachments/assets/47743fc1-d1ba-45d6-a97a-727afc84a9cb" />

<br />

#### Scheduled Pipeline

The Nightly Build workflow can be scheduled to run on an interval by going to Build -> Pipeline Schedules on the left menu.
<br />

<img width="1353" height="744" alt="Screenshot 2025-10-22 at 12 26 55 PM" src="https://github.com/user-attachments/assets/c13d5819-2e99-48d1-aada-5e22480d801c" />

<br />

Once here, select the blue button in the upper right labeled "New Schedule"

<br />

<img width="1353" height="172" alt="Screenshot 2025-10-22 at 12 28 08 PM" src="https://github.com/user-attachments/assets/3ae0fb05-df6c-44d2-a060-ab23041ff6be" />

<br />

Fill out the fields on the New Schedule page and *be sure to set the correct input parameters as described in the Manual Trigger section*

<br />

<br />

## 4. Nightly Test Workflow

### Background Information

The Nightly Test workflow is generated from a combination of GitLab CI jobs statically and dynamically generated.

The static CI jobs are defined in `.gitlab-ci.yml`:
* [Nightly-Test-Generate](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L84-98) - Lines 84-98
* [Nightly-Test](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L100-108) - Lines 100-108

The purpose of these statically defined CI jobs is to allow a dynamic nightly-test pipeline to be generated. By generating the pipeline dynamically, we can structure it such that jobs are run with a degree of user-defined concurrency/parallelism. This is done using a GitLab feature called Parent-Child Downstream Pipelines. Please see the official documentation for general information on this GitLab feature:
* https://docs.gitlab.com/ci/pipelines/downstream_pipelines/

The dynamic CI jobs are generated by, and executed using, the scripts in the [nightly-test directory](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/f6be3bc459b61c67b070a8fdaff0025315b33170/nightly-test).

### Running the Workflow

This workflow can be triggered either manually, or by scheduling the workflow to run on some user-defined interval.

#### Manual Trigger

To manually trigger the workflow, go to Build -> Pipelines using the menu on the left. Then, click the blue button labeled "New Pipeline" in the upper right.

In the "Run new pipeline" screen, set the following pipeline Inputs:
* Set **ocean_branch** to the target branch
* Set **nightly_test** to True.
* Set **concurrency** to the desired degree of parallelism*

_* A note about the value of `CONCURRENCY`: this integer should not be larger than the max concurrency supported by your gitlab-runner configuration. For instance, if you were to set a value of CONCURRENCY=10 but you had configured your gitlab-runner to only support 5 concurrent jobs, only 5 build jobs would run concurrently._

<br />

<img width="1333" height="572" alt="Screenshot 2025-11-23 at 5 48 50 PM" src="https://github.com/user-attachments/assets/806ad503-298f-4431-b61d-b9af1ab397e0" />

<br />

Once the pipeline is triggered, it will look like this at first:

<br />

<img width="1353" height="503" alt="Screenshot 2025-10-22 at 12 41 54 PM" src="https://github.com/user-attachments/assets/669574e3-c662-422c-a286-6e22255ab8c2" />

<br />

You should initially see only the Nightly-Test-Generate job running. The purpose of this job is to split up all the package tests into a number of buckets corresponding to the value of `CONCURRENCY`. 

<br />

It should only take a short period of time before the Nightly-Test-Generate job completes, at which point the Nightly-Test Downstream job will be triggered. Once this happens, you should be able to expand that job and see the full set of build jobs that are being run. It will look something like this:
<br />

<img width="1353" height="777" alt="Screenshot 2025-10-22 at 12 44 29 PM" src="https://github.com/user-attachments/assets/251edeb6-3d00-46a2-8789-2a81fefc70c5" />

<br />

#### Scheduled Pipeline

Please follow the instructions in the Nightly Buid workflow section on how to schedule a pipeline run. The same steps are used to schedule a run of this workflow. The only difference is in what CI input values you pick.

<br />

<br />

## 5. VM Image Build

### Background Information

The VM Build CI jobs are defined in the following files:

In `.gitlab-ci.yml` as the following CI jobs:
* [VM-Build-x86_64](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L110-124) - Lines 110-124
* [VM-Build-aarch64](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L126-140) - Lines 126-140

And there are associated scripts in the [create-vm-image](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/f6be3bc459b61c67b070a8fdaff0025315b33170/create-vm-image) path.

### Running the workflow

The Rift VM images can be built with GitLab CI by following the instructions below. These VM images are constructed according to the logic embedded in `rift vm build`.

There are two required parameters that need to be specified to control the building of Rift VM's using GitLab CI:
1. The Ocean branch used (eg. 4.4)
2. The target hardware architecture (x86_64 or aarch64)

These required parameters are specified as GitLab CI Pipeline variables when launching the pipeline either manually or on a schedule.
* Set **ocean_branch** to the target branch
* Set **vm_build_x86_64** to True, if you want to build the x86_64 VM.
* Set **vm_build_aarch64** to True, if you want to build the aarch64 VM.

To manually trigger the VM build workflow, navigate to the left-hand menu and select "Build" and then select "Pipelines." Once in the pipeline view, click on the blue button labeled "New Pipeline" in the upper right. On the next screen, specify the required pipeline inputs and then select the blue button in the lower left that says "New Pipeline"

<br />

<img width="1333" height="572" alt="Screenshot 2025-11-23 at 5 54 08 PM" src="https://github.com/user-attachments/assets/7329d45f-3527-41cb-b416-a8bcfbf4cb5c" />

<br />

The newly created pipeline should show a job called "VM-Build-x86_64."
<br />

<img width="1320" height="470" alt="Screenshot 2025-11-02 at 1 12 33 PM" src="https://github.com/user-attachments/assets/f196dc67-2322-4aea-8383-ddfaaa749efc" />

<br />

This job will generate a new VM by running `rift vm build` on the specified Ocean branch and then copy it to the Harbor forge.

The final portion of the job output should confirm the VM has been created and show the transfer to Harbor.
<br />

<img width="1320" height="768" alt="Screenshot 2025-11-02 at 1 18 02 PM" src="https://github.com/user-attachments/assets/84a3a7c9-3229-4a8d-8570-239e328c0d2f" />

<br />

That the new VM image has been transferred to the Harbor can be further confirmed by manually SFTP'ing and checking:
<br />

<img width="1001" height="211" alt="Screenshot 2025-11-02 at 1 20 42 PM" src="https://github.com/user-attachments/assets/e211d50b-6b9c-4bfd-9765-7575522501da" />

<br />

<br />


## 6. Sanity Check

### Background Information

The Sanity Check CI job is defined in the following files:

In `.gitlab-ci.yml` as the following CI jobs:
* [Sanity-Check](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/blob/f6be3bc459b61c67b070a8fdaff0025315b33170/.gitlab-ci.yml#L142-155) - Lines 142-155

The scripts associated with this job are in the [sanity-check](https://gitlab-forge.ccc.ocre.cea.fr/paratools/ocean-prod/-/tree/f6be3bc459b61c67b070a8fdaff0025315b33170/sanity-check) path.

### Running the Workflow

This workflow can be triggered either manually, or by scheduling the workflow to run on some user-defined interval.

#### Manual Trigger

To manually trigger the workflow, go to Build -> Pipelines using the menu on the left. Then, click the blue button labeled "New Pipeline" in the upper right.

In the "Run new pipeline" screen, set the following pipeline Inputs:
* Set **ocean_branch** to the branch you want to sanity check
* Set **sanity_check** to True.

Once you've done this, click the blue button at the bottom labeled "New Pipeline."

<br />

<img width="1359" height="811" alt="Screenshot 2025-11-23 at 5 21 24 PM" src="https://github.com/user-attachments/assets/48362c43-3e16-418b-aec7-cfd2544366ed" />

<br />

The resulting pipeline should have a single job labeled **Sanity-Check**.

The results of the Sanity-Check will be presented at the end of the job log. They will look like this:

<br />

<img width="1287" height="807" alt="Screenshot 2025-11-23 at 5 25 03 PM" src="https://github.com/user-attachments/assets/753e8cf7-5f9c-46e2-8a08-5eaab75cb43d" />

<br />

#### Scheduled Pipeline

Please follow the instructions in the Nightly Buid workflow section on how to schedule a pipeline run. The same steps are used to schedule a run of this workflow. The only difference is in what CI input values you pick.

<br />


